services:
    # ================================
    # Aplicação Next.js - QR Code Tracker
    # ================================
    # Usa o banco de dados existente no container 'contador-visitas-db'
    # ================================
    app:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: qrcode-app
        restart: unless-stopped
        ports:
            - "3007:3000"
        environment:
            - NODE_ENV=production
            # Conecta ao container PostgreSQL existente 'contador-visitas-db'
            # Formato: postgresql://usuario:senha@container_name:5432/nome_do_banco
            - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@contador-visitas-db:5432/${POSTGRES_DB:-qrcode_tracker}?schema=public
            - NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-sua-chave-secreta-aqui}
            - IP_HASH_SALT=${IP_HASH_SALT:-salt-secreto-para-hash}
            - NEXT_PUBLIC_BASE_URL=${NEXT_PUBLIC_BASE_URL:-http://localhost:3007}
        healthcheck:
            test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        networks:
            - contador-network

# ================================
# Rede externa - usa a mesma rede do container contador-visitas-db
# ================================
networks:
    contador-network:
        external: true
        name: contador-de-visitas_contador-network
